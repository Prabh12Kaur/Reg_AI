<!DOCTYPE html>
<html>
<head>
  <title>Doctor Interface</title>
</head>
<body>
  <h1>Doctor Panel</h1>
  <div id="department-label" style="font-size: 20px; color: green;"></div>

  <button onclick="callNext()">Call Next</button>
  <button onclick="announceAgain()">Announce Again</button>
  <div id="current" style="margin-top: 20px;">No token yet</div>

  <script>
    const urlParams = new URLSearchParams(window.location.search);
    const departmentId = urlParams.get("department_id") || "OPD";

    let currentToken = null;
    let currentName = null;

    fetch(`http://localhost:5000/api/department-name?department_id=${departmentId}`)
      .then(res => res.json())
      .then(data => {
        document.getElementById("department-label").textContent =
          `Department: ${data.department_name || departmentId}`;
      });

    function callNext() {
      fetch('http://localhost:5000/api/call-next', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ department_id: departmentId })
      })
      .then(res => res.json())
      .then(data => {
        if (data.token) {
          document.getElementById("current").innerText = `Token ${data.token}: ${data.name}`;
          currentToken = data.token;
          currentName = data.name;
        } else {
          document.getElementById("current").innerText = data.message;
        }
      });
    }

    function announceAgain() {
      if (currentToken && currentName) {
        fetch('http://localhost:5000/api/announce-current', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ department_id: departmentId })
        })
        .then(res => res.json())
        .then(data => {
          console.log(data.message || "Announcement repeated");
        });
      } else {
        alert("No current token to announce");
      }
    }

    function loadCurrentToken() {
      fetch(`http://localhost:5000/api/current-token?department_id=${departmentId}`)
        .then(res => res.json())
        .then(data => {
          if (data.token && data.name) {
            document.getElementById("current").innerText = `Token ${data.token}: ${data.name}`;
            currentToken = data.token;
            currentName = data.name;
          }
        });
    }

    window.onload = loadCurrentToken;
  </script>
</body>
</html>
